<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>üö¶ Sous‚Äëstation: Localise & R√©enclenche ‚Äî 30s</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <meta name="theme-color" content="#0ea5e9" />
  <style>
    :root{
      --bg:#0b1020; --panel:#101a36; --panel2:#0c142b; --rail:#263145; --sleeper:#334155; --text:#e6eefc;
      --muted:#9fb3d9; --ok:#22c55e; --bad:#ef4444; --warn:#f59e0b; --accent:#38bdf8; --shadow:0 8px 28px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial;
      background: radial-gradient(1200px 700px at 50% -10%, #0f1a37 0%, var(--bg) 55%);
      color:var(--text); -webkit-tap-highlight-color:transparent; user-select:none;
    }
    .wrap{max-width:920px; margin:0 auto; min-height:100%; padding:14px 12px 24px; display:flex; flex-direction:column; gap:10px}

    header{display:flex; align-items:center; justify-content:space-between; gap:10px}
    h1{font-size:clamp(1.05rem,3vw,1.35rem); margin:0; display:flex; align-items:center; gap:.5rem}
    .badge{font-size:.8rem; padding:.22rem .55rem; border-radius:999px; background:linear-gradient(180deg,#182444,#0d1530); color:var(--muted); border:1px solid rgba(255,255,255,.08)}

    .panel{background:linear-gradient(180deg,var(--panel),var(--panel2)); border:1px solid rgba(255,255,255,.08); border-radius:var(--radius); box-shadow:var(--shadow)}

    .hud{display:grid; grid-template-columns:1fr auto 1fr; gap:10px; align-items:center; padding:10px 12px}
    .tile{padding:10px 12px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.06); border-radius:12px; text-align:center; min-width:110px}
    .time,.score{font-size:1.35rem; font-weight:900}
    .center{display:flex; gap:8px; align-items:center}
    .cta{border:1px solid rgba(255,255,255,.1); background:linear-gradient(180deg,#172347,#0d1530); color:var(--text); border-radius:12px; padding:10px 14px; font-weight:800; letter-spacing:.2px}
    .cta.primary{background:linear-gradient(180deg,#60a5fa,#3b82f6); color:#041019; border:none}

    /* Zone de jeu */
    .game{display:grid; grid-template-columns:1fr; gap:10px; padding:10px}
    .tracks{position:relative; height:min(64vh,520px); min-height:360px; border-radius:16px; overflow:hidden; background:linear-gradient(180deg,#0e1732,#0b1329)}
    .legend{position:absolute; top:8px; left:8px; display:flex; gap:10px; font-size:.9rem; color:var(--muted)}
    .legend span{display:inline-flex; align-items:center; gap:6px; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.06); padding:4px 8px; border-radius:999px}
    .legend .dot{width:10px; height:10px; border-radius:50%}
    .dot.ok{background:var(--ok)} .dot.bad{background:var(--bad)} .dot.warn{background:var(--warn)}

    .track{position:absolute; left:0; right:0; height:14%; display:flex; align-items:center}
    .track::before{content:""; position:absolute; left:0; right:0; height:3px; background:linear-gradient(90deg, var(--rail) 0 8px, transparent 8px 12px) repeat-x; transform:translateY(-8px)}
    .track::after{content:""; position:absolute; left:0; right:0; height:3px; background:linear-gradient(90deg, var(--rail) 0 8px, transparent 8px 12px) repeat-x; transform:translateY(8px)}
    .sleeper{position:absolute; left:0; right:0; height:2px; background:repeating-linear-gradient(90deg, transparent 0 24px, var(--sleeper) 24px 34px); opacity:.7}

    .train{position:absolute; bottom:50%; transform:translateY(50%); font-size:26px; filter:drop-shadow(0 4px 6px rgba(0,0,0,.45)); pointer-events:auto; cursor:pointer}
    .train.stopped{opacity:.9; filter:grayscale(.1) drop-shadow(0 4px 6px rgba(0,0,0,.5))}
    .train.fault{animation:blink .5s linear infinite}
    @keyframes blink{50%{transform:translateY(50%) scale(1.06)}}

    .powerZone{position:absolute; inset:0; pointer-events:none}
    .power-off{position:absolute; left:0; right:0; background:linear-gradient(90deg, rgba(239,68,68,.12), rgba(239,68,68,.06)); border-top:1px dashed rgba(239,68,68,.45); border-bottom:1px dashed rgba(239,68,68,.45)}

    /* Commandes d√©parts */
    .controls{display:grid; grid-template-columns:repeat(4,1fr); gap:10px; padding:10px}
    @media (max-width:560px){ .controls{grid-template-columns:1fr 1fr} }
    .btn{appearance:none; border:none; border-radius:16px; padding:14px 10px; font-weight:900; font-size:1.05rem; letter-spacing:.3px; color:#041019; background:linear-gradient(180deg,#86efac,#22c55e); box-shadow:0 10px 18px rgba(0,0,0,.25), inset 0 -3px 0 rgba(0,0,0,.12)}
    .btn.off{background:linear-gradient(180deg,#fecaca,#ef4444); color:#240a0a}
    .btn.warn{background:linear-gradient(180deg,#fde68a,#f59e0b); color:#201604}
    .btn:active{transform:translateY(2px)}
    .btn .sub{display:block; font-size:.8rem; font-weight:700; opacity:.8}

    /* Etat & messages */
    .status{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 14px; border-top:1px solid rgba(255,255,255,.08)}
    .state{display:flex; align-items:center; gap:10px; color:var(--muted)}
    .msg{color:var(--muted)}

    /* Modal fin */
    .modal{position:fixed; inset:0; display:none; place-items:center; background:rgba(4,10,20,.66); backdrop-filter:saturate(130%) blur(6px); z-index:30; padding:18px}
    .modal.show{display:grid}
    .card{width:min(660px,100%); background:linear-gradient(180deg,#111a36,#0b142a); border:1px solid rgba(255,255,255,.08); border-radius:22px; padding:18px; box-shadow:var(--shadow); text-align:center}
    .score-big{font-size:2.4rem; font-weight:900; margin:8px 0}
    footer{margin-top:auto; text-align:center; color:var(--muted); opacity:.85; font-size:.88rem}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>‚ö° Sous‚Äëstation ‚Äî Localiser la panne & r√©enclencher <span class="badge">30 s</span></h1>
      <div class="badge">6 voies ¬∑ 4 d√©parts</div>
    </header>

    <section class="panel">
      <div class="hud">
        <div class="tile">
          <div style="font-size:.9rem;color:var(--muted)">‚è±Ô∏è Temps</div>
          <div class="time" id="time">30.0</div>
        </div>
        <div class="center">
          <button id="startBtn" class="cta primary">D√©marrer</button>
          <button id="resetBtn" class="cta">R√©initialiser</button>
        </div>
        <div class="tile">
          <div style="font-size:.9rem;color:var(--muted)">üèÜ Score</div>
          <div class="score" id="score">0</div>
        </div>
      </div>

      <div class="game">
        <div class="tracks" id="tracks">
          <div class="legend">
            <span><span class="dot ok"></span> Alimentation OK</span>
            <span><span class="dot bad"></span> D√©part ouvert</span>
            <span><span class="dot warn"></span> Train en panne</span>
          </div>
          <!-- Lignes (6) -->
          <!-- mapping voies‚Üíd√©parts: V1‚ÜíD1, V2‚ÜíD1, V3‚ÜíD2, V4‚ÜíD2, V5‚ÜíD3, V6‚ÜíD4 -->
          <!-- elles sont positionn√©es verticalement en pourcent -->
          <div class="track" data-lane="1" style="top:8%"><div class="sleeper"></div></div>
          <div class="track" data-lane="2" style="top:24%"><div class="sleeper"></div></div>
          <div class="track" data-lane="3" style="top:40%"><div class="sleeper"></div></div>
          <div class="track" data-lane="4" style="top:56%"><div class="sleeper"></div></div>
          <div class="track" data-lane="5" style="top:72%"><div class="sleeper"></div></div>
          <div class="track" data-lane="6" style="top:88%"><div class="sleeper"></div></div>

          <!-- zones coup√©es (affich√©es dynamiquement) -->
          <div class="powerZone" id="powerZone"></div>
        </div>

        <div class="controls" id="controls">
          <button class="btn off" data-depart="1" id="d1">D√©part 1 <span class="sub">OUVERT</span></button>
          <button class="btn off" data-depart="2" id="d2">D√©part 2 <span class="sub">OUVERT</span></button>
          <button class="btn off" data-depart="3" id="d3">D√©part 3 <span class="sub">OUVERT</span></button>
          <button class="btn off" data-depart="4" id="d4">D√©part 4 <span class="sub">OUVERT</span></button>
        </div>
      </div>

      <div class="status">
        <div class="state">
          <span id="stateDot" class="dot ok" style="width:12px;height:12px;border-radius:50%"></span>
          <strong id="stateText">R√©seau stable</strong>
        </div>
        <div class="msg" id="msg">Astuce‚ÄØ: tape le train en panne (ic√¥ne ‚ö°) puis r√©enclenche le d√©part correspondant.</div>
      </div>
    </section>

    <!-- Modal fin -->
    <div class="modal" id="modal">
      <div class="card">
        <h2>Fin de manche</h2>
        <div class="score-big" id="finalScore">0</div>
        <p id="summary">Tu as r√©tabli l‚Äôalim rapidement. Bravo‚ÄØ!</p>
        <div style="display:flex; gap:10px; justify-content:center; margin-top:10px">
          <button class="cta primary" id="playAgain">Rejouer</button>
          <button class="cta" id="closeModal">Fermer</button>
        </div>
      </div>
    </div>

    <footer>
      Version : <strong>v1.0.0</strong> ‚Äî 12/08/2025
    </footer>
  </div>

  <script>
  ;(()=>{
    // =========================
    // Mod√®le sous-station
    // =========================
    // Voies (1..6) mapp√©es sur 4 d√©parts
    const laneToDepart = {1:1, 2:1, 3:2, 4:2, 5:3, 6:4};
    const departState = {1:false, 2:false, 3:false, 4:false}; // false=OUVERT (coup√©), true=FERM√â (alim)
    const trains = []; // {el, lane, x, dir, speed, stopped, fault}
    const tracksEl = document.getElementById('tracks');
    const powerZoneEl = document.getElementById('powerZone');

    const timeEl = document.getElementById('time');
    const scoreEl = document.getElementById('score');
    const msgEl = document.getElementById('msg');
    const stateDot = document.getElementById('stateDot');
    const stateText = document.getElementById('stateText');

    const startBtn = document.getElementById('startBtn');
    const resetBtn = document.getElementById('resetBtn');
    const modal = document.getElementById('modal');
    const finalScore = document.getElementById('finalScore');
    const summary = document.getElementById('summary');
    const playAgain = document.getElementById('playAgain');
    const closeModal = document.getElementById('closeModal');

    const btns = [...document.querySelectorAll('.btn[data-depart]')];

    // Audio simple (WebAudio)
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    let audioCtx;
    function beep(freq=720, dur=0.06, gain=0.03, type='sine'){
      try{
        audioCtx = audioCtx || new AudioCtx();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type=type; o.frequency.value=freq; g.gain.value=gain;
        o.connect(g); g.connect(audioCtx.destination);
        o.start();
        setTimeout(()=>{o.stop();o.disconnect();g.disconnect();}, dur*1000);
      }catch(e){}
    }
    const buzz = (ms=30)=>{ if(navigator.vibrate) try{ navigator.vibrate(ms); }catch(e){} };

    // Jeu
    let running=false, last=0, remTime=30.0, score=0;
    let faultActive=false, faultTrain=null, faultDepart=null;
    let spawnTimer=0;

    function setDepartState(d, closed){
      departState[d] = !!closed;
      const b = document.getElementById('d'+d);
      b.classList.remove('off','warn');
      b.classList.add(closed ? '' : 'off');
      b.querySelector('.sub').textContent = closed ? 'FERM√â' : 'OUVERT';
      if (!closed) b.classList.add('off');
    }

    function renderPowerZones(){
      powerZoneEl.innerHTML = '';
      for(const lane in laneToDepart){
        const d = laneToDepart[lane];
        if(!departState[d]){ // coup√©
          const laneIdx = +lane;
          const top = [0,8,24,40,56,72,88][laneIdx]; // from inline styles
          const bar = document.createElement('div');
          bar.className = 'power-off';
          bar.style.top = (top-6)+'%';
          bar.style.height = '14%';
          powerZoneEl.appendChild(bar);
        }
      }
    }

    function updateNetworkStateText(){
      const anyOpen = Object.values(departState).some(v=>!v);
      stateDot.className = 'dot ' + (anyOpen ? 'bad' : 'ok');
      stateText.textContent = anyOpen ? 'D√©part ouvert ‚Äî trafic perturb√©' : 'R√©seau stable';
    }

    function spawnTrain(){
      // Choisit une voie au hasard, une direction al√©atoire
      const lane = 1 + Math.floor(Math.random()*6);
      const dir = Math.random() < 0.5 ? 1 : -1; // 1=gauche‚Üídroite (x augmente), -1= droite‚Üígauche
      const el = document.createElement('div');
      el.className = 'train';
      // Emoji train vari√©
      el.textContent = Math.random() < 0.75 ? 'üöÜ' : 'üöÇ';

      // Position Y selon la voie (match le .track top)
      const laneTops = {1:'8%',2:'24%',3:'40%',4:'56%',5:'72%',6:'88%'};
      el.style.top = laneTops[lane];

      // Position X initiale hors √©cran
      let x = dir === 1 ? -60 : tracksEl.clientWidth + 60;
      const speed = 80 + Math.random()*55; // px/s

      // Gestion du tap sur train
      el.addEventListener('click', ()=>onTrainTap(obj));
      el.addEventListener('touchstart', (e)=>{e.preventDefault(); onTrainTap(obj);}, {passive:false});

      tracksEl.appendChild(el);

      const obj = {el, lane, x, dir, speed, stopped:false, fault:false, removed:false};
      trains.push(obj);
      positionTrain(obj);
    }

    function positionTrain(t){
      t.el.style.left = t.x + 'px';
    }

    function removeTrain(t){
      t.removed = true;
      try{ t.el.remove(); }catch(e){}
    }

    function onTrainTap(t){
      if(!running) return;
      // Si un d√©faut est actif, et que c‚Äôest ce train ‚Üí localis√©
      if(faultActive && t === faultTrain){
        t.el.classList.remove('fault');
        t.el.classList.add('stopped');
        msgEl.textContent = 'Panne localis√©e ‚úÖ ‚Äî R√©enclenche le d√©part ' + faultDepart;
        document.getElementById('d'+faultDepart).classList.add('warn'); // attire l‚Äô≈ìil
        beep(980, .08, .05);
        buzz(30);
        faultTrain.localized = true;
      } else if(!faultActive) {
        // Petit point si tap reflexe (juste pour le fun)
        score += 1;
        scoreEl.textContent = Math.round(score);
        beep(780,.04,.03);
      }
    }

    function triggerFault(){
      if(trains.length === 0) return;
      // Choisit un train aliment√© pour d√©clencher un d√©faut
      const candidates = trains.filter(t=>!t.removed && !t.stopped);
      if(candidates.length === 0) return;
      const t = candidates[Math.floor(Math.random()*candidates.length)];
      const d = laneToDepart[t.lane];
      faultActive = true; faultTrain = t; faultDepart = d;
      // Ouvre le d√©part s‚Äôil √©tait ferm√©
      setDepartState(d, false);
      updateNetworkStateText(); renderPowerZones();
      // Marque le train en d√©faut
      t.fault = true; t.stopped = true; t.el.classList.add('fault','stopped'); t.el.textContent = '‚ö°üöÜ';
      // Tous les trains sur ce d√©part s‚Äôarr√™tent
      trains.forEach(o=>{
        if(o !== t && laneToDepart[o.lane] === d){ o.stopped = true; o.el.classList.add('stopped'); }
      });
      msgEl.textContent = '‚ö†Ô∏è D√©part ' + d + ' ouvert (train en panne). Localise la panne (tap sur ‚ö°) puis r√©enclenche.';
      beep(360,.15,.045,'square'); buzz(60);
      // mesure du temps de r√©paration
      faultStartTs = performance.now();
    }

    // Temps de r√©paration
    let faultStartTs = 0;

    // Contr√¥le des d√©parts
    btns.forEach(b=>{
      b.addEventListener('click', ()=>{
        const d = +b.dataset.depart;
        // Si on tente de fermer pendant un d√©faut non localis√© ‚Üí refuser
        if(faultActive && d === faultDepart && !faultTrain?.localized){
          msgEl.textContent = 'üß≠ Localise d‚Äôabord le train en d√©faut (tap sur ‚ö°) avant de r√©enclencher.';
          beep(220,.08,.05,'square'); buzz(20);
          return;
        }
        // Toggle
        const willClose = !departState[d];
        setDepartState(d, willClose);
        renderPowerZones();
        updateNetworkStateText();
        if(willClose){
          beep(820,.06,.04); buzz(20);
          // Si c‚Äô√©tait le d√©part en d√©faut et panne localis√©e ‚Üí reprise trafic + score
          if(faultActive && d === faultDepart){
            const dt = (performance.now()-faultStartTs)/1000;
            const impacted = trains.filter(o=>laneToDepart[o.lane]===d && o.stopped).length;
            const pts = Math.max(2, Math.round(16 - dt)) + Math.max(0, impacted-1)*2;
            score += pts;
            scoreEl.textContent = Math.round(score);
            msgEl.textContent = `‚úÖ D√©part ${d} r√©enclench√© ‚Äî +${pts} pts (r√©paration ${dt.toFixed(1)}s, ${impacted} train(s))`;
            // Repartir les trains de ce d√©part
            trains.forEach(o=>{
              if(laneToDepart[o.lane]===d){ o.stopped=false; o.el.classList.remove('stopped'); if(o.fault){o.fault=false; o.el.textContent = Math.random()<0.5?'üöÜ':'üöÇ'; } }
            });
            // Fin du d√©faut
            faultActive=false; faultTrain=null; faultDepart=null;
            btns.forEach(x=>x.classList.remove('warn'));
          }
        }else{
          // Ouverture manuelle = p√©nalit√© l√©g√®re
          score = Math.max(0, score-2);
          scoreEl.textContent = Math.round(score);
          msgEl.textContent = `‚õî D√©part ${d} ouvert ‚Äî p√©nalit√© -2 pts.`;
          beep(300,.06,.04,'square');
        }
      });
    });

    function startGame(){
      if(running) return;
      resetGame();
      running = true;
      last = performance.now();
      requestAnimationFrame(loop);
    }

    function endGame(){
      running = false;
      finalScore.textContent = Math.round(score);
      const repairs = Math.max(0, totalFaultsFixed);
      summary.textContent = `Pannes r√©solues: ${repairs}. Score bas√© sur la rapidit√© et le trafic.`;
      modal.classList.add('show');
    }

    function resetGame(){
      running=false; remTime=30.0; score=0; scoreEl.textContent='0'; timeEl.textContent=remTime.toFixed(1);
      // Supprime trains
      trains.splice(0).forEach(t=>{ try{ t.el.remove(); }catch(e){} });
      // D√©parts ferm√©s (alimentation OK) au d√©part
      setDepartState(1,true); setDepartState(2,true); setDepartState(3,true); setDepartState(4,true);
      renderPowerZones(); updateNetworkStateText();
      msgEl.textContent = 'Astuce‚ÄØ: tape le train ‚ö° puis r√©enclenche le bon d√©part.';
      spawnTimer = 0;
      faultActive=false; faultTrain=null; faultDepart=null; totalFaultsFixed=0;
    }

    let totalFaultsFixed = 0;
    // D√©tection des fins de d√©faut (compte)
    const observer = new MutationObserver(()=>{
      if(!faultActive && faultStartTs>0){ totalFaultsFixed++; faultStartTs=0; }
    });
    observer.observe(document.body,{subtree:true, childList:true, attributes:true});

    startBtn.addEventListener('click', startGame);
    resetBtn.addEventListener('click', resetGame);
    playAgain.addEventListener('click', ()=>{ modal.classList.remove('show'); startGame(); });
    closeModal.addEventListener('click', ()=> modal.classList.remove('show'));

    function loop(now){
      if(!running) return;
      const dt = Math.min(0.03, (now - last)/1000); // ~33 FPS cap
      last = now;

      // Timer
      remTime -= dt; if(remTime<=0){ timeEl.textContent='0.0'; endGame(); return; }
      timeEl.textContent = remTime.toFixed(1);

      // Spawn trains
      spawnTimer -= dt;
      if(spawnTimer <= 0){
        spawnTrain();
        // rythme variable
        spawnTimer = 0.7 + Math.random()*0.9;
      }

      // D√©clencher al√©atoirement un d√©faut si aucun n‚Äôest actif
      if(!faultActive && Math.random() < 0.006){ // proba par frame ‚Üí ~toutes les 6‚Äì10 s
        triggerFault();
      }

      // Mouvement des trains
      const W = tracksEl.clientWidth;
      for(const t of trains){
        if(t.removed) continue;
        // Si d√©part de sa voie est coup√© ‚Üí stop
        if(!departState[laneToDepart[t.lane]]) t.stopped = true;
        if(!t.stopped){
          t.x += t.dir * t.speed * dt;
          positionTrain(t);
        }
        // Sorti de l‚Äô√©cran ‚Üí supprimer
        if(t.dir===1 && t.x > W+80) removeTrain(t);
        if(t.dir===-1 && t.x < -80) removeTrain(t);
      }

      requestAnimationFrame(loop);
    }

    // D√©marrage "pr√™t"
    resetGame();

    // Raccourcis clavier (desktop)
    window.addEventListener('keydown', (e)=>{
      if(e.repeat) return;
      if(e.key===' '||e.key==='Enter') startGame();
      if(e.key.toLowerCase()==='r') resetGame();
      if(['1','2','3','4'].includes(e.key)){ document.getElementById('d'+e.key).click(); }
    });
  })();
  </script>
</body>
</html>
